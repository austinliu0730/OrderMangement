@model OrderMangement.Models.OrderSearchViewModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link href="~/Content/Search.css" rel="stylesheet" />
</head>
<body>
    <div class="container" style="margin-top: 20px;">

       

        <div class="search-form">
            @using (Html.BeginForm("Index", "Orders", FormMethod.Get))
            {
                <div class="form-inline">
                    <label>客戶:</label>
                    <input type="text" name="customerName" value="@Model.CustomerName" placeholder="輸入客戶名稱" class="form-control" />

                    <label>訂單日期:</label>
                    <input type="date" name="orderDate" value="@Model.OrderDate" class="form-control" />

                    <label>產品:</label>
                    <select name="productID" class="form-control">
                        <option value="">全部產品</option>
                        @foreach (var item in ViewBag.Products as SelectList)
                        {
                            <option value="@item.Value" @(item.Selected ? "selected" : "")>@item.Text</option>
                        }
                    </select><br />

                    <button type="submit" class="btn btn-outline-primary">查詢</button>
                    <a href="@Url.Action("Index")" class="btn btn-outline-primary">清除</a>
                    @Html.ActionLink("新增訂單", "Create", null, new { @class = "btn btn-outline-primary" })
                   
                </div>
            }
        </div>

        <hr />

        @* 產品統計資訊區塊 *@
        @if (Model.TotalPriceResult != null)
        {
            <div class="alert alert-info" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-graph-up"></i> 產品統計資訊
                </h5>
                <hr />
                <div class="row">
                    <div class="col-md-4">
                        <strong>產品名稱：</strong>
                        <span class="fs-5">@Model.TotalPriceResult.ProductName</span>
                    </div>
                    <div class="col-md-4">
                        <strong>總數量：</strong>
                        <span class="fs-5 text-primary">@Model.TotalPriceResult.TotalQuantity.ToString("N0")</span>
                    </div>
                    <div class="col-md-4">
                        <strong>總價格：</strong>
                        <span class="fs-5 text-success">$ @Model.TotalPriceResult.TotalPrice.ToString("N0")</span>
                    </div>
                </div>
            </div>
        }

        <table class="table table-striped table-bordered">
            <thead>
                <tr  class="text-center">
                    <th>客戶</th>
                    <th>產品名稱</th>
                    <th>數量</th>
                    <th>總價</th>
                    <th>
                        @{
                            // 計算下一個排序方向
                            var nextSortOrder = Model.SortOrder == "desc" ? "asc" : "desc";
                            var sortIcon = Model.SortOrder == "desc" ? "▼" : "▲";
                        }
                        <a href="@Url.Action("Index", new { customerName = Model.CustomerName, orderDate = Model.OrderDate, page = 1, sortOrder = nextSortOrder, productID = Model.ProductID })"
                           style="text-decoration: none; color: inherit; cursor: pointer;"
                           title="點擊切換排序">
                            訂單日期 <span style="font-size: 0.8em;">@sortIcon</span>
                        </a>
                    </th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Orders != null && Model.Orders.Any())
                {
                    foreach (var item in Model.Orders)
                    {
                        <tr class="text-center">
                            <td>
                                @Html.DisplayFor(modelItem => item.Customer.CustomerName)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Product.ProductName)
                            </td>
                            <td >
                                @Html.DisplayFor(modelItem => item.Quantity)
                            </td>
                            <td class="text-right">
                                @((item.Quantity * item.Product.Price).ToString("N0"))
                            </td>
                            <td>
                                @item.OrderDate.ToString("yyyy/MM/dd")
                            </td>
                            <td class="text-center">

                                @Html.ActionLink("修改", "Edit", new { id = item.OrderID }, new { @class = "btn btn-link" })
                                <button type="button" class="btn btn-link" onclick="deleteOrderAjax(@item.OrderID)">刪除</button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center">查無訂單資料</td>
                    </tr>
                }
            </tbody>
        </table>

        @* 分頁資訊 *@
        @if (Model.TotalCount > 0)
        {
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span class="text-muted">
                        共 @Model.TotalCount 筆資料，
                        顯示第 @((Model.PageNumber - 1) * Model.PageSize + 1) - @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount) 筆
                    </span>
                </div>

                @* 分頁控制列 *@
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Page navigation">
                        <ul class="pagination mb-0">
                            @* 上一頁按鈕 *@
                            <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                                @if (Model.PageNumber > 1)
                                {
                                    <a class="page-link" href="@Url.Action("Index", new { customerName = Model.CustomerName, orderDate = Model.OrderDate, 
                                                              page = Model.PageNumber - 1, sortOrder = Model.SortOrder, productID = Model.ProductID })" aria-label="上一頁">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                }
                                else
                                {
                                    <span class="page-link" aria-label="上一頁">
                                        <span aria-hidden="true">&laquo;</span>
                                    </span>
                                }
                            </li>

                            @* 頁碼按鈕 *@
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { customerName = Model.CustomerName, orderDate = Model.OrderDate, 
                                                              page = i, sortOrder = Model.SortOrder, productID = Model.ProductID })">
                                        @i
                                    </a>
                                </li>
                            }

                            @* 下一頁按鈕 *@
                            <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                                @if (Model.PageNumber < Model.TotalPages)
                                {
                                    <a class="page-link" href="@Url.Action("Index", new { customerName = Model.CustomerName, orderDate = Model.OrderDate, 
                                                              page = Model.PageNumber + 1, sortOrder = Model.SortOrder, productID = Model.ProductID })" aria-label="下一頁">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                }
                                else
                                {
                                    <span class="page-link" aria-label="下一頁">
                                        <span aria-hidden="true">&raquo;</span>
                                    </span>
                                }
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        }
    </div>

    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>

    <script>
        // AJAX 刪除訂單
        function deleteOrderAjax(orderId) {
            if (!confirm('確定要刪除這筆訂單嗎？')) return;

            $.ajax({
                url: '/Orders/DeleteAjax',
                type: 'POST',
                data: { id: orderId },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();  // 重新載入頁面
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('刪除失敗');
                }
            });
        }
    </script>

</body>
</html>